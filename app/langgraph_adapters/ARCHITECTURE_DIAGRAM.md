# ğŸ—ï¸ Diagrama de Arquitectura HÃ­brida LangChain + LangGraph

## Vista General del Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                     USUARIO                                     â”‚
â”‚                         "Â¿CuÃ¡nto cuesta el botox?"                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          MULTI-AGENT ORCHESTRATOR GRAPH                         â”‚
â”‚                              (LangGraph StateGraph)                             â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                           ESTADO COMPARTIDO                             â”‚  â”‚
â”‚  â”‚  {                                                                      â”‚  â”‚
â”‚  â”‚    "question": "Â¿CuÃ¡nto cuesta el botox?",                            â”‚  â”‚
â”‚  â”‚    "user_id": "user123",                                              â”‚  â”‚
â”‚  â”‚    "company_id": "company_abc",                                        â”‚  â”‚
â”‚  â”‚    "intent": "SALES",                                                  â”‚  â”‚
â”‚  â”‚    "confidence": 0.95,                                                 â”‚  â”‚
â”‚  â”‚    "agent_response": "El tratamiento de botox...",                    â”‚  â”‚
â”‚  â”‚    "executions": [...],                                                â”‚  â”‚
â”‚  â”‚    "validations": [...],                                               â”‚  â”‚
â”‚  â”‚    "errors": []                                                         â”‚  â”‚
â”‚  â”‚  }                                                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚  START   â”‚ â”€â”€â–¶ â”‚ Validate Input â”‚ â”€â”€â–¶ â”‚ Classify    â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚                â”‚     â”‚ Intent      â”‚                     â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                   â”‚                             â”‚
â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚                                    â”‚   Routing Condicional       â”‚             â”‚
â”‚                                    â”‚   (basado en confidence)    â”‚             â”‚
â”‚                                    â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                       â”‚        â”‚        â”‚                       â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚                   â”‚                            â”‚                        â”‚       â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”â”‚
â”‚           â”‚ Execute Sales â”‚          â”‚Execute Support  â”‚      â”‚Execute Emerge.â”‚â”‚
â”‚           â”‚               â”‚          â”‚                 â”‚      â”‚               â”‚â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                   â”‚                            â”‚                        â”‚       â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                 â”‚                                               â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚                        â”‚ Validate Output â”‚                                      â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                                 â”‚                                               â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚                          â”‚   Â¿Retry?   â”‚                                        â”‚
â”‚                          â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜                                        â”‚
â”‚                             â”‚       â”‚                                           â”‚
â”‚                         NO  â”‚       â”‚ SÃ                                        â”‚
â”‚                             â”‚       â”‚                                           â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”    â””â”€â”€â–¶ [Handle Retry] â”€â”€â–¶ [Escalate]        â”‚
â”‚                   â”‚    END     â”‚                                                â”‚
â”‚                   â”‚  Response  â”‚                                                â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            AGENT ADAPTER LAYER                                  â”‚
â”‚                         (NormalizaciÃ³n de Interfaz)                             â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   RouterAdapter       â”‚   â”‚   SalesAdapter        â”‚   â”‚  SupportAdapter  â”‚ â”‚
â”‚  â”‚                       â”‚   â”‚                       â”‚   â”‚                  â”‚ â”‚
â”‚  â”‚ â€¢ Logging automÃ¡tico  â”‚   â”‚ â€¢ Logging automÃ¡tico  â”‚   â”‚ â€¢ Logging auto.  â”‚ â”‚
â”‚  â”‚ â€¢ ValidaciÃ³n inputs   â”‚   â”‚ â€¢ ValidaciÃ³n I/O      â”‚   â”‚ â€¢ ValidaciÃ³n     â”‚ â”‚
â”‚  â”‚ â€¢ MÃ©tricas            â”‚   â”‚ â€¢ Reintentos (max 2)  â”‚   â”‚ â€¢ Reintentos     â”‚ â”‚
â”‚  â”‚ â€¢ Timeout: 10s        â”‚   â”‚ â€¢ Timeout: 30s        â”‚   â”‚ â€¢ Timeout: 30s   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â”‚                           â”‚                         â”‚           â”‚
â”‚              â–¼                           â–¼                         â–¼           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                           â”‚                         â”‚
              â–¼                           â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          LANGCHAIN AGENTS LAYER                                 â”‚
â”‚                         (Agentes Existentes - Sin Modificar)                    â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  RouterAgent    â”‚   â”‚  SalesAgent      â”‚   â”‚  SupportAgent            â”‚    â”‚
â”‚  â”‚                 â”‚   â”‚                  â”‚   â”‚                          â”‚    â”‚
â”‚  â”‚ â€¢ Classify      â”‚   â”‚ â€¢ RAG Context    â”‚   â”‚ â€¢ RAG Context            â”‚    â”‚
â”‚  â”‚   intent        â”‚   â”‚ â€¢ Custom Prompts â”‚   â”‚ â€¢ Custom Prompts         â”‚    â”‚
â”‚  â”‚ â€¢ JSON output   â”‚   â”‚ â€¢ Company Config â”‚   â”‚ â€¢ Company Config         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  EmergencyAgent             â”‚   â”‚  ScheduleAgent                         â”‚ â”‚
â”‚  â”‚                             â”‚   â”‚                                        â”‚ â”‚
â”‚  â”‚ â€¢ Urgency detection         â”‚   â”‚ â€¢ Date extraction                     â”‚ â”‚
â”‚  â”‚ â€¢ RAG Context               â”‚   â”‚ â€¢ Availability check                  â”‚ â”‚
â”‚  â”‚ â€¢ Escalation protocols      â”‚   â”‚ â€¢ Booking API calls                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                           â”‚                         â”‚
              â–¼                           â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              SERVICIOS EXTERNOS                                 â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  OpenAI API      â”‚   â”‚  Vectorstore     â”‚   â”‚  Calendar Integration    â”‚   â”‚
â”‚  â”‚                  â”‚   â”‚  (RAG)           â”‚   â”‚  (Google/Calendly)       â”‚   â”‚
â”‚  â”‚ â€¢ GPT-4          â”‚   â”‚ â€¢ Pinecone       â”‚   â”‚ â€¢ Check availability     â”‚   â”‚
â”‚  â”‚ â€¢ Embeddings     â”‚   â”‚ â€¢ Company filter â”‚   â”‚ â€¢ Create bookings        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujo Detallado: EjecuciÃ³n Exitosa

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 1: Entrada del Usuario                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Usuario envÃ­a: "Â¿CuÃ¡nto cuesta el tratamiento de botox?"

Estado inicial creado:
{
  "question": "Â¿CuÃ¡nto cuesta el tratamiento de botox?",
  "user_id": "user123",
  "company_id": "company_abc",
  "chat_history": [],
  "context": "",
  "intent": null,
  "confidence": 0.0,
  "agent_response": null,
  "executions": [],
  "validations": [],
  "errors": [],
  "retries": 0
}

        â”‚
        â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 2: Nodo - validate_input                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Validaciones realizadas:
  âœ… question no vacÃ­a
  âœ… user_id vÃ¡lido
  âœ… company_id coincide

Estado actualizado:
{
  ...
  "validations": [
    {
      "is_valid": true,
      "errors": [],
      "warnings": [],
      "metadata": {"question_length": 46}
    }
  ]
}

DecisiÃ³n: Â¿Continuar? â†’ SÃ

        â”‚
        â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 3: Nodo - classify_intent                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ejecutar RouterAgent mediante AgentAdapter:

  RouterAdapter.invoke({
    "question": "Â¿CuÃ¡nto cuesta el tratamiento de botox?",
    "chat_history": []
  })

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ RouterAgent (LangChain)             â”‚
  â”‚                                     â”‚
  â”‚ 1. Recibe pregunta                  â”‚
  â”‚ 2. Analiza keywords:                â”‚
  â”‚    - "cuÃ¡nto" â†’ precio              â”‚
  â”‚    - "cuesta" â†’ precio              â”‚
  â”‚    - "botox" â†’ tratamiento          â”‚
  â”‚ 3. Clasifica: SALES                 â”‚
  â”‚ 4. Confianza: 0.95 (muy alta)      â”‚
  â”‚ 5. Retorna JSON:                    â”‚
  â”‚    {                                â”‚
  â”‚      "intent": "SALES",             â”‚
  â”‚      "confidence": 0.95,            â”‚
  â”‚      "keywords": ["cuÃ¡nto", "cuesta"]
  â”‚    }                                â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Resultado: âœ… Success
Duration: 234.56ms

Estado actualizado:
{
  ...
  "intent": "SALES",
  "confidence": 0.95,
  "intent_keywords": ["cuÃ¡nto", "cuesta"],
  "executions": [
    {
      "agent_name": "router",
      "status": "success",
      "duration_ms": 234.56,
      "retries": 0
    }
  ]
}

        â”‚
        â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 4: Routing Condicional                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

EvaluaciÃ³n:
  intent = "SALES"
  confidence = 0.95 > 0.7 â†’ Alta confianza

DecisiÃ³n: Ir a â†’ execute_sales

        â”‚
        â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 5: Nodo - execute_sales                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ejecutar SalesAgent mediante AgentAdapter:

  SalesAdapter.invoke({
    "question": "Â¿CuÃ¡nto cuesta el tratamiento de botox?",
    "chat_history": [],
    "context": "",
    "user_id": "user123",
    "company_id": "company_abc"
  })

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ SalesAgent (LangChain)                              â”‚
  â”‚                                                     â”‚
  â”‚ 1. Preparar contexto RAG:                           â”‚
  â”‚    vectorstore.search("botox precio")               â”‚
  â”‚    â†’ [                                              â”‚
  â”‚         "Botox: $300,000 - $500,000",              â”‚
  â”‚         "DuraciÃ³n: 4-6 meses",                     â”‚
  â”‚         "Tratamiento rÃ¡pido: 15 min"               â”‚
  â”‚       ]                                             â”‚
  â”‚                                                     â”‚
  â”‚ 2. Construir prompt con contexto:                   â”‚
  â”‚    "Eres un especialista en ventas..."             â”‚
  â”‚    "InformaciÃ³n disponible: [RAG context]"         â”‚
  â”‚    "Pregunta: Â¿CuÃ¡nto cuesta el botox?"           â”‚
  â”‚                                                     â”‚
  â”‚ 3. Ejecutar LLM (GPT-4):                           â”‚
  â”‚    chat_model.invoke(prompt)                        â”‚
  â”‚                                                     â”‚
  â”‚ 4. Generar respuesta:                               â”‚
  â”‚    "Â¡Hola! El tratamiento de botox tiene una       â”‚
  â”‚     inversiÃ³n entre $300,000 y $500,000.           â”‚
  â”‚     Los resultados duran de 4 a 6 meses y          â”‚
  â”‚     el procedimiento es muy rÃ¡pido (15 min).       â”‚
  â”‚     Â¿Te gustarÃ­a agendar tu cita?"                 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Resultado: âœ… Success
Duration: 1523.45ms

Estado actualizado:
{
  ...
  "current_agent": "sales",
  "agent_response": "Â¡Hola! El tratamiento de botox...",
  "executions": [
    {...router execution...},
    {
      "agent_name": "sales",
      "status": "success",
      "duration_ms": 1523.45,
      "retries": 0,
      "output": "Â¡Hola! El tratamiento de botox..."
    }
  ]
}

        â”‚
        â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 6: Nodo - validate_output                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Validaciones realizadas:
  âœ… Response no vacÃ­a
  âœ… Longitud razonable (> 10 caracteres)
  âœ… Sin errores en ejecuciÃ³n

Estado actualizado:
{
  ...
  "validations": [
    {...input validation...},
    {
      "is_valid": true,
      "errors": [],
      "warnings": [],
      "metadata": {"response_length": 235}
    }
  ]
}

DecisiÃ³n: Â¿Retry? â†’ NO (validation OK)

        â”‚
        â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 7: END                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Estado final:
{
  "question": "Â¿CuÃ¡nto cuesta el tratamiento de botox?",
  "user_id": "user123",
  "company_id": "company_abc",
  "intent": "SALES",
  "confidence": 0.95,
  "current_agent": "sales",
  "agent_response": "Â¡Hola! El tratamiento de botox tiene una inversiÃ³n...",
  "executions": [
    {router: success, 234.56ms},
    {sales: success, 1523.45ms}
  ],
  "validations": [
    {input: valid},
    {output: valid}
  ],
  "errors": [],
  "retries": 0,
  "started_at": "2025-10-24T10:15:23Z",
  "completed_at": "2025-10-24T10:15:25Z"
}

RETORNO A USUARIO:
  response = "Â¡Hola! El tratamiento de botox tiene una inversiÃ³n..."
  agent_used = "sales"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… EJECUCIÃ“N COMPLETADA CON Ã‰XITO                        â”‚
â”‚                                                           â”‚
â”‚ Total duration: ~1758ms                                   â”‚
â”‚ Nodes executed: 7                                         â”‚
â”‚ Retries: 0                                                â”‚
â”‚ Agent used: sales                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujo Alternativo: Con Reintentos y Escalado

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ESCENARIO: EmergencyAgent falla, escalar a SupportAgent                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Usuario: "Â¡Emergencia! Tengo mucho dolor despuÃ©s del tratamiento"

[validate_input] âœ…

[classify_intent]
  â””â”€â–¶ Intent: EMERGENCY, Confidence: 0.98

[execute_emergency]
  â””â”€â–¶ EmergencyAgent.invoke()
      â””â”€â–¶ âŒ ERROR: OpenAI API timeout (30s exceeded)

Estado:
{
  ...
  "current_agent": "emergency",
  "agent_response": null,
  "errors": ["emergency failed: OpenAI API timeout"],
  "executions": [
    {
      "agent_name": "emergency",
      "status": "failed",
      "error": "OpenAI API timeout"
    }
  ]
}

[validate_output]
  â””â”€â–¶ Validation failed: Response is empty
  â””â”€â–¶ should_retry = True

[handle_retry]
  â””â”€â–¶ retries = 1 (< max 2)
  â””â”€â–¶ agent_response is null â†’ should_escalate = True
  â””â”€â–¶ DecisiÃ³n: ESCALAR a support

[execute_support]
  â””â”€â–¶ SupportAgent.invoke()
      â””â”€â–¶ âœ… Success: "Lo siento por las molestias. Voy a conectarte
                       inmediatamente con nuestro equipo de urgencias..."

Estado final:
{
  ...
  "current_agent": "support",
  "agent_response": "Lo siento por las molestias...",
  "executions": [
    {emergency: failed, timeout},
    {support: success, 892.34ms}
  ],
  "retries": 1
}

[END]

RETORNO:
  response = "Lo siento por las molestias. Voy a conectarte..."
  agent_used = "support"  # â† Escalado desde emergency

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… RECUPERACIÃ“N EXITOSA VÃA ESCALADO                     â”‚
â”‚                                                           â”‚
â”‚ Original intent: emergency                                â”‚
â”‚ Final agent: support (fallback)                          â”‚
â”‚ Retries: 1                                                â”‚
â”‚ User experience: No se pierde la conversaciÃ³n            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ComparaciÃ³n: Antes vs DespuÃ©s

### ANTES (LangChain puro)

```
Usuario â†’ get_response()
           â”‚
           â”œâ”€â–¶ RouterAgent.invoke() â†’ JSON
           â”‚
           â”œâ”€â–¶ if intent == "SALES":
           â”‚     â””â”€â–¶ SalesAgent.invoke() â†’ response
           â”‚
           â”œâ”€â–¶ elif intent == "SUPPORT":
           â”‚     â””â”€â–¶ SupportAgent.invoke() â†’ response
           â”‚
           â”œâ”€â–¶ else:
           â”‚     â””â”€â–¶ SupportAgent.invoke() â†’ response
           â”‚
           â””â”€â–¶ return response

Estado: Disperso en variables locales
Validaciones: ImplÃ­citas (try/except)
Reintentos: Manuales
Logging: Ad-hoc
```

### DESPUÃ‰S (LangChain + LangGraph)

```
Usuario â†’ get_response()
           â”‚
           â”œâ”€â–¶ create_initial_state()
           â”‚    â””â”€â–¶ OrchestratorState
           â”‚
           â”œâ”€â–¶ StateGraph.invoke(state)
           â”‚    â”‚
           â”‚    â”œâ”€â–¶ [validate_input] â”€â”
           â”‚    â”‚                      â”œâ”€â–¶ state.validations.append()
           â”‚    â”‚                      â””â”€â–¶ continue/end
           â”‚    â”‚
           â”‚    â”œâ”€â–¶ [classify_intent] â”€â”
           â”‚    â”‚                       â”œâ”€â–¶ RouterAdapter.invoke()
           â”‚    â”‚                       â”œâ”€â–¶ state.executions.append()
           â”‚    â”‚                       â””â”€â–¶ state.intent = "SALES"
           â”‚    â”‚
           â”‚    â”œâ”€â–¶ [route_to_agent] â”€â”
           â”‚    â”‚                      â””â”€â–¶ conditional: sales/support/...
           â”‚    â”‚
           â”‚    â”œâ”€â–¶ [execute_sales] â”€â”
           â”‚    â”‚                     â”œâ”€â–¶ SalesAdapter.invoke()
           â”‚    â”‚                     â”œâ”€â–¶ state.executions.append()
           â”‚    â”‚                     â””â”€â–¶ state.agent_response = "..."
           â”‚    â”‚
           â”‚    â”œâ”€â–¶ [validate_output] â”€â”
           â”‚    â”‚                       â”œâ”€â–¶ state.validations.append()
           â”‚    â”‚                       â””â”€â–¶ retry/end
           â”‚    â”‚
           â”‚    â””â”€â–¶ END â”€â–¶ final_state
           â”‚
           â””â”€â–¶ return final_state.agent_response

Estado: Centralizado en StateGraph
Validaciones: ExplÃ­citas en nodos
Reintentos: AutomÃ¡ticos con routing
Logging: Estructurado por nodo
```

---

## Arquitectura de Datos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FLUJO DE DATOS                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

INPUT (Usuario):
  {
    "question": "Â¿Precios?",
    "user_id": "user123",
    "chat_history": []
  }

       â†“

STATE (Durante ejecuciÃ³n - mutable):
  {
    "question": "Â¿Precios?",          # â† Input original (inmutable)
    "user_id": "user123",             # â† Input original
    "company_id": "company_abc",      # â† Inyectado por orchestrator
    "intent": "SALES",                # â† Agregado por classify_intent
    "confidence": 0.95,               # â† Agregado por classify_intent
    "agent_response": "El precio...", # â† Agregado por execute_sales
    "executions": [...],              # â† Acumulado en cada nodo
    "validations": [...],             # â† Acumulado en validaciones
    "errors": [],                     # â† Acumulado si hay errores
    "retries": 0                      # â† Incrementado en retry
  }

       â†“

OUTPUT (A usuario):
  (
    "El precio de nuestros tratamientos...",  # response
    "sales"                                   # agent_used
  )
```

---

**Diagrama creado por**: Claude Code
**Fecha**: 2025-10-24
**VersiÃ³n**: 1.0.0
